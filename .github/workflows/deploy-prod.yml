name: Deploy to Release (Production)

# Trigger on push to any branch matching 'release/*' or specific release tag
on:
  push:
    branches: [ "release" ] 
  workflow_dispatch:

env:
  AWS_REGION: ${{ secrets.AWS_REGION }}
  ECR_REPOSITORY: ${{ secrets.ECR_REPOSITORY }}

permissions:
  contents: read

jobs:
  build-and-push:
    name: Build and Push to ECR
    runs-on: ubuntu-latest
    outputs:
      registry: ${{ steps.login-ecr.outputs.registry }}
      image_tag: ${{ steps.image_tag.outputs.sha }}

    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Login to Amazon ECR
      id: login-ecr
      uses: aws-actions/amazon-ecr-login@v2

    - name: Create Image Tag
      id: image_tag
      run: echo "sha=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT

    - name: Build and Push Docker Image
      id: build-image
      env:
        ECR_REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        IMAGE_TAG: ${{ steps.image_tag.outputs.sha }}
      run: |
        docker build -t $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG -t $ECR_REGISTRY/$ECR_REPOSITORY:production .
        docker push $ECR_REGISTRY/$ECR_REPOSITORY:$IMAGE_TAG
        docker push $ECR_REGISTRY/$ECR_REPOSITORY:production

  deploy-prod:
    name: Deploy to Production EC2
    needs: build-and-push
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Copy docker-compose.yml to Prod Server
      uses: appleboy/scp-action@master
      with:
        host: ${{ secrets.PROD_EC2_HOST }}
        username: ${{ secrets.SSH_USERNAME }}
        key: ${{ secrets.PROD_EC2_SSH_KEY }}
        source: "docker-compose.yml"
        target: "~/apps/image-generation/"

    - name: Execute Remote Deployment
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.PROD_EC2_HOST }}
        username: ${{ secrets.SSH_USERNAME }}
        key: ${{ secrets.PROD_EC2_SSH_KEY }}
        script: |
          mkdir -p ~/apps/image-generation
          cd ~/apps/image-generation
          
          # ===== STEP 0: Install AWS CLI if not present =====
          if ! command -v aws &> /dev/null; then
            echo "Installing AWS CLI..."
            curl "https://awscli.amazonaws.com/awscli-exe-linux-x86_64.zip" -o "awscliv2.zip"
            unzip -q awscliv2.zip
            sudo ./aws/install
            rm -rf aws awscliv2.zip
          fi
          
          # ===== STEP 1: Setup AWS Credentials =====
          export AWS_ACCESS_KEY_ID="${{ secrets.AWS_ACCESS_KEY_ID }}"
          export AWS_SECRET_ACCESS_KEY="${{ secrets.AWS_SECRET_ACCESS_KEY }}"
          export AWS_DEFAULT_REGION="${{ secrets.AWS_REGION }}"
          
          # ===== STEP 2: Construct ECR Registry URL =====
          AWS_ACCOUNT_ID=$(aws sts get-caller-identity --query Account --output text)
          ECR_REGISTRY="${AWS_ACCOUNT_ID}.dkr.ecr.${{ secrets.AWS_REGION }}.amazonaws.com"
          ECR_REPOSITORY="${{ secrets.ECR_REPOSITORY }}"
          IMAGE="${ECR_REGISTRY}/${ECR_REPOSITORY}:production"
          
          echo "=========================================="
          echo "AWS_ACCOUNT_ID: $AWS_ACCOUNT_ID"
          echo "ECR_REGISTRY: $ECR_REGISTRY"
          echo "IMAGE: $IMAGE"
          echo "=========================================="
          
          # ===== STEP 3: Validate Variables =====
          if [ -z "$AWS_ACCOUNT_ID" ] || [ -z "$ECR_REPOSITORY" ]; then
            echo "ERROR: AWS_ACCOUNT_ID or ECR_REPOSITORY is empty!"
            exit 1
          fi
          
          # ===== STEP 4: Login to ECR =====
          aws ecr get-login-password --region ${{ secrets.AWS_REGION }} | docker login --username AWS --password-stdin $ECR_REGISTRY
          
          # ===== STEP 5: Write Environment File =====
          cat << 'ENVEOF' > .env
          ${{ secrets.PROD_ENV_FILE }}
          ENVEOF
          
          # ===== STEP 6: Stop and Remove Old Container =====
          echo "Stopping previous container..."
          docker stop grovio-images-api || true
          docker rm grovio-images-api || true
          
          echo "Removing previous image..."
          docker rmi $IMAGE || true
          
          # ===== STEP 7: Pull and Run New Container =====
          echo "Pulling latest image..."
          docker pull $IMAGE
          
          echo "Starting container..."
          docker run -d \
            --name grovio-images-api \
            --restart unless-stopped \
            --env-file .env \
            -p 5005:5005 \
            $IMAGE
          
          echo "Pruning dangling images..."
          docker image prune -f
          
          echo "=========================================="
          echo "Production deployment completed successfully!"
          docker ps | grep grovio-images-api
          echo "=========================================="
